<html>

<head>
  <title>商品列表</title>
  <!-- <link rel="stylesheet" href="/stylesheets/style.css"> -->
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
  <!-- Favicon-->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <!-- Bootstrap icons-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />
  <script>
    function logout() {
        let api_url = '../user/logout';
        let request = new XMLHttpRequest();
        request.open("GET", api_url, true);
        request.send();
        request.onload = function() {
            response = JSON.parse(request.responseText);
            if (response["success"] == true) {
                alert(response['message']);
                window.location = '../Login.html';
            } else if (response["success"] == false) {
              alert(response['message']);
              window.location = '../Login.html';
            }
        }
    }
  </script>
   <script>
    function add_product_topool() {
          let product_url = document.getElementById('product_url').value;
          let api_url = "../product/add_product_topool";
          let data = {'input_url': product_url};
          let param = JSON.stringify(data)
          let request = new XMLHttpRequest();
          request.open("POST", api_url, true);
  
          request.setRequestHeader("Content-Type", "application/json");
          request.send(param);
          request.onload = function() {
              response = JSON.parse(request.responseText);
              if (response["success"] == true) {
                  alert(response['message'])
                  location.reload()
              } else if (response["success"] == false) {
                  alert(response['message']);
                  location.reload()
              }
          }
      }
    </script>
    <script>
      $(document).ready(function(){
        $("#table").on('click','.btn-danger',function(){
            let currentRow = $(this).closest("tr"); 
            let product_id = currentRow.attr('id')
            // let product_name = currentRow.find("th:eq(0)").text();
            // let product_price = currentRow.find("td:eq(0)").text(); 
            // let channel_name = currentRow.find("td:eq(1)").text(); 
            // let product_url = currentRow.find("td:eq(2)").find('a').attr('href')

            let api_url = "../product/delete_product/";
            let data = {'id': product_id};
            let param = JSON.stringify(data)
            let request = new XMLHttpRequest();
            request.open("DELETE", api_url, true);
            request.setRequestHeader("Content-Type", "application/json");
            request.send(param);
            request.onload = function() {
                response = JSON.parse(request.responseText);
                if (response["success"] == true) {
                    alert(response['message'])
                    location.reload()
                } else if (response["success"] == false) {
                    alert(response['message']);
                    location.reload()
                }
            }
        });
      });
   </script>
    <script>
      $(document).ready(function(){
        $("#table").on('click','.btn-success',function(){
            let currentRow = $(this).closest("tr"); 
            let product_id = currentRow.attr('id')
            let product_url = currentRow.find("td:eq(2)").find('a').attr('href')
            let product_name = currentRow.find("th:eq(0)").text();
            let product_price = currentRow.find("td:eq(0)").text(); 
            // let channel_name = currentRow.find("td:eq(1)").text(); 
            
            let api_url = "../product/update_product/";
            let data = {'input_url': product_url, 'id': product_id, 'original_product_name': product_name, 
                        'original_product_price': product_price};
            let param = JSON.stringify(data)
            let request = new XMLHttpRequest();
            request.open("PUT", api_url, true);
            request.setRequestHeader("Content-Type", "application/json");
            request.send(param);
            request.onload = function() {
                response = JSON.parse(request.responseText);
                if (response["success"] == true) {
                    alert(response['message'])
                    location.reload()
                } else if (response["success"] == false) {
                    alert(response['message']);
                    location.reload()
                }
            }
        });
      });
   </script>


</head>

<body>
  <!-- Responsive navbar-->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container px-lg-12">
      <a class="navbar-brand text-center" >{{member_id}}的商品列表</a>
      <button background-color="black"  onclick="logout()">登出</button>
       
      </div>
    </div>
  </nav>
  <!-- Header-->
  
    <div class="container px-lg-12">
                    <form class="row row-cols-lg-auto g-3 justify-content-center align-items-center mb-4 pb-2">
                      <div class="col-12">
                        <div class="form-outline">
                          <input type="text" id="product_url" class="form-control" / placeholder="輸入商品的URL">
                        </div>
                      </div>
                      <br></br>
                      <br></br>
                      <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="add_product_topool()">Add Product</button>
                      </div>
                    </form>
                    <hr>
                    </hr>
                    <button type="button" class="btn btn-success ms-1">Update All Products</button>
                    <br></br>
                    <table class="table mb-5" id="table">
                      <thead>
                        <tr>
                          <th scope="col" width="60%">名稱</th>
                          <th scope="col" width="10%">價格</th>
                          <th scope="col" width="10%">商城</th>
                          <th scope="col" width="10%">連結</th>
                          <th scope="col" width="10%">動作</th>
                        </tr>
                      </thead>
                      <tbody>
                        {%for product in product_rows%}
                        <tr id={{product.id}}>
                          <th scope="row">{{product.product_name}}</th>
                          <td>{{product.product_price}}</td>
                          <td>{{product.channel_name}}</td>
                          <td><a href={{product.product_url}}>商品連結</a></td>
                          <td>
                            <button type="button" class="btn btn-success ms-1">Update</button>
                            <br></br>
                            <button type="button" class="btn btn-danger">Delete</button>
                          </td>
                        </tr>
                        {%endfor%}
                      </tbody>
                    </table>

    </div>

  <!-- Page Content-->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
<html>